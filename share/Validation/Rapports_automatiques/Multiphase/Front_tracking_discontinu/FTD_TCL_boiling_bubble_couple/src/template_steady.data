# Boiling bubble simulation #
# lance_test 4 ecarts #
# PARALLEL RUNS #
dimension 2 
PrecisionGeom 1e-18
bidim_axi 

domaine dom_fluide
domaine dom_solide

# BEGIN MESH #
Mailler dom_fluide
{

   Pave pave1
   { 
   origine 0. 0.
   longueurs 0.333 0.333 
   nombre_de_noeuds @Nx1@ @Ny1@
   Facteurs 1. 1.0
   }
   {
   bord left1     X = 0.          0. <= Y <= 0.333
   raccord distant homogene bot1      Y = 0.          0. <= X <= 0.333
   } ,
   
   Pave pave2
   { 
   origine 0.333 0.
   longueurs 0.667 0.333 
   nombre_de_noeuds @Nx2@ @Ny1@
   Facteurs 1.05 1.0
   }
   {
   raccord distant homogene bot2      Y = 0.          0.333 <= X <= 1.
   bord right1    X = 1.          0. <= Y <= 0.333
   } ,
   
   Pave pave3
   { 
   origine 0. 0.333
   longueurs 0.333 0.667 
   nombre_de_noeuds @Nx1@ @Ny2@
   Facteurs 1.0 1.05
   }
   {
   bord top1     Y = 1.          0. <= X <= 0.333
   bord left2    X = 0.          0.333 <= Y <= 1.
   } ,
   
   Pave pave4
   { 
   origine 0.333 0.333
   longueurs 0.667 0.667 
   nombre_de_noeuds @Nx2@ @Ny2@
   Facteurs 1.05 1.05
   }
   {
   bord top2      Y = 1.          0.333 <= X <= 1.
   bord right2    X = 1.          0.333 <= Y <= 1.
   }
}
RegroupeBord dom_fluide bot { bot1 bot2 } 
RegroupeBord dom_fluide up { top1 top2 } 
RegroupeBord dom_fluide left { left1 left2 } 
RegroupeBord dom_fluide right { right1 right2 } 
transformer dom_fluide x*@rmax@ y*@zmax@

Mailler dom_solide
{  
   Pave pave5
   { 
   origine 0. 0.
   longueurs 0.333 1.
   nombre_de_noeuds @Nx1@ @Ny3@
   Facteurs 1.0 1.05
   }
   {
   raccord distant homogene sup1     Y = 1.          0. <= X <= 0.333
   bord sbot1     Y = 0.          0. <= X <= 0.333
   bord sleft    X = 0.          0 <= Y <= 1.
   } ,
   
   Pave pave6
   { 
   origine 0.333 0.
   longueurs 0.667 1. 
   nombre_de_noeuds @Nx2@ @Ny3@
   Facteurs 1.05 1.05
   }
   {
   raccord distant homogene sup2      Y = 1.          0.333 <= X <= 1.
   bord sbot2     Y = 0.          0.333 <= X <= 1.
   bord sright    X = 1.          0 <= Y <= 1.
   }
}
RegroupeBord dom_solide sbot { sbot1 sbot2 } 
RegroupeBord dom_solide sup { sup1 sup2 } 
transformer dom_solide x*@rmax@ (y-1.)*@zsol@     
# END MESH #

# BEGIN PARTITION
Partition dom_fluide
{
   Partitionneur tranche { tranches @nprocx@ @nprocy@ }
   Larg_joint 2
   Nom_Zones DOM_FLUIDE
}

Partition dom_solide
{
   Partitionneur tranche { tranches @nprocx@ @nprocy@ }
   Larg_joint 2
   Nom_Zones DOM_SOLIDE
}

Fin
END PARTITION #

# BEGIN SCATTER 
Scatter ../MESH/DOM_FLUIDE.Zones dom_fluide
Scatter ../MESH/DOM_SOLIDE.Zones dom_solide
 END SCATTER #

Probleme_FT_Disc_gen pb1
Pb_conduction pb2
Fluide_Incompressible  liquid_water
Lire liquid_water 
{
  mu champ_uniforme       1 2.8e-4
  rho champ_uniforme      1 958.37
  lambda champ_uniforme   1 0.679
  cp champ_uniforme       1 4.21e3
  # import CoolProp.CoolProp as CP
  P,Q -> (pression, fraction de vapeur)
  CP.PropsSI('ISOBARIC_EXPANSION_COEFFICIENT', "P", 101325, "Q", 0, "Water")                                                     0.0007504815417629351
  CP.PropsSI('ISOBARIC_EXPANSION_COEFFICIENT', "P", 101325, "Q", 1, "Water")                                                     0.002902383982248589
  Ou pas a saturation:
  PropsSI('ISOBARIC_EXPANSION_COEFFICIENT','P',101325,'T',373.124,'Water')  #
  beta_th Champ_Uniforme  1 0.0007504815417629351
}

Fluide_Incompressible vapeur
Lire vapeur
{
  mu champ_uniforme       1 1.227e-5
  rho champ_uniforme      1 0.597 
  lambda champ_uniforme   1 0.025
  cp champ_uniforme       1 2.077e3 
  beta_th Champ_Uniforme  1 0.002902383982248589
}

Fluide_diphasique fluide
Lire fluide
{
  fluide1 liquid_water
  fluide0 vapeur
  sigma   Champ_Uniforme 1            5.89e-2
  chaleur_latente Champ_Uniforme 1    -2.256e6
}

Solide sol
Read sol
{
	rho Uniform_Field 1 8500.
	lambda Champ_Uniforme 1 234.    
	Cp Champ_Uniforme 1 376.
}

Schema_Euler_explicite  sch
Lire sch
{
   nb_pas_dt_max 1000000000 # 12 HACK #
   tinit 0.
   tmax 15. # 50e-3 #
   tcpumax 23.75
   dt_min 1.e-18
   dt_max 1.e-3
               # 1e-7 is necessary on coa test otherwise it is unstable at 89.4e-4 with remesh BEST #
   dt_impr 2.e-6
   impr_diffusion_implicite 1
   dt_sauv 0.5
   facsec 1.
   seuil_statio 1e-12
   diffusion_implicite 1
   dt_start dt_min
   seuil_diffusion_implicite 1e-6
   periode_sauvegarde_securite_en_heures 0.5
}


Champ_Uniforme gravite
Lire gravite 2 0. -9.81
Associate fluide gravite 

Navier_stokes_FT_disc                         hydraulique
Transport_interfaces_FT_disc                  interf
convection_diffusion_temperature_ft_disc      thermique
convection_diffusion_temperature_ft_disc      thermique_vapeur 
Associate pb1 dom_fluide
Associate pb1 hydraulique
Associate pb1 thermique
Associate pb1 thermique_vapeur 
Associate pb1 interf
Associate pb1 fluide

Associate pb2 dom_solide
Associate pb2 sol

Probleme_Couple pbc
Associate pbc pb1
Associate pbc pb2

Associate pbc sch
VDF dis
Discretize pbc dis
system "mkdir -p lata slata"
option_vdf { All_options } # To set the BC of pressure on the Boundary, not at the center of ghost cells! #
Lire pb1
{
  
   hydraulique
   {
        parametre_equation parametre_diffusion_implicite
        {
            solveur petsc gcp { precond block_jacobi_ilu { level 0 } rtol 1.e-13 impr }
        }
      modele_turbulence nul
      solveur_pression GCP { precond ssor { omega 1.5 } seuil 1e-14 impr }
      convection { quick }
      diffusion { }
      conditions_initiales { vitesse champ_uniforme 2 0. 0. }
      projection_initiale 0
      dt_projection 1.e-10 1.e-18
      equation_interfaces_proprietes_fluide interf
      equation_temperature_mpoint thermique
      equation_temperature_mpoint_vapeur thermique_vapeur 
      new_mass_source   # -> it's a flag, when not activated, the variable is 0 #
      # when new_mass_source is used, it forces the use of the new jump(1/rho)*ai*mp as a source term in the RHS of Poisson instead of the historical div(delta_u) #
      interpol_indic_pour_dI_dt interp_modifiee # interp_ai_based #
      OutletCorrection_pour_dI_dt CORRECTION_GHOST_INDIC
      terme_gravite grad_I
      boussinesq_approximation
      boundary_conditions 
      {
      right   sortie_libre_rho_variable champ_front_fonc_xyz 1 0. # -958.37*9.81*(Y-0.009) cela depend de l'option terme_gravite #
      bot     paroi_fixe 
      up      sortie_libre_rho_variable champ_front_uniforme 1 0.
      left    Symetrie
      }
   }
   interf
   {
      type_indic_faces standard # interpolation to faces of indic : { STANDARD, MODIFIEE, AI_BASED } #
      # interpolation_repere_local #
      methode_interpolation_v vdf_lineaire
      methode_transport vitesse_interpolee hydraulique
      conditions_initiales { fonction 1. }
      VOFlike_correction_volume 1 # Flag to activate the VOF-like volume conservation (dI/dt) #
      nb_iterations_correction_volume 1 # to get the correct dI/dt #
      nb_lissage_correction_volume 1 # To smooth the dI/dt correction to avoid pikes on the interface #
      n_iterations_distance 8
      # Bloc Remesh Best # 
      remaillage {
                    pas 1e-12
                    nb_iter_remaillage 3
                    critere_arete 0.35
                    critere_remaillage 0.35
                    pas_lissage 1e-12
                    relax_barycentrage 0.1
                    facteur_longueur_ideale 1.0
                    nb_iter_barycentrage 1
                    nb_iter_correction_volume 3
                    seuil_dvolume_residuel 1e-15
                    lissage_courbure_coeff -0.02
                    lissage_courbure_iterations_systematique 1
                    lissage_courbure_iterations_si_remaillage 5
      }
      # End Remesh Best #
      collisions
      {
                active
                juric_pour_tout
                juric_local  phase_continue 1 
                type_remaillage Juric { source_isovaleur indicatrice }
      }
      parcours_interface { Correction_Parcours_Thomas }
      boundary_conditions
      {
      bot    Paroi_FT_disc constant champ_front_fonc_xyz 1 @theta@*(x_ge_200.e-6)+135*(x_lt_200.e-6) # to pinch contact line #
      right  Paroi_FT_disc Symetrie
      up     Paroi_FT_disc Symetrie
      left   Paroi_FT_disc Symetrie
      }
   }
   
   thermique
   {
      parametre_equation parametre_diffusion_implicite
        {
            solveur petsc gcp { precond block_jacobi_ilu { level 0 } rtol 1.e-13 impr }
        }
      # Pb quand on fait ça, il ne calcul pas le dt_stab de convection en FTD?? #
      # Parametre_equation parametre_implicite { resolution_explicite } #
      equation_interface interf
      equation_navier_stokes hydraulique
      phase 1
                stencil_width 9
                correction_mpoint_diff_conv_energy 3 0 0 0 # diff conv energy #
                diffusion { }
                convection { quick }
                boundary_conditions
                {
                bot   paroi_temperature_imposee champ_front_Uniforme 1 @dT@
                up    frontiere_ouverte T_ext Champ_front_Uniforme 1 0.0
                right  frontiere_ouverte T_ext Champ_front_Fonc_xyz 1 (@dT@*(1-erf(y/@delta_th@)))
                left  Symetrie
                }
              conditions_initiales { Temperature_thermique Champ_Fonc_xyz dom_fluide 1 (@dT@*(1-erf(y/@delta_th@))+0.01*sin(6.2831*x/@rmax@)) }
   }
   thermique_vapeur
   {
      parametre_equation parametre_diffusion_implicite
        {
            solveur petsc gcp { precond block_jacobi_ilu { level 0 } rtol 1.e-13 impr }
        }
      # Pb quand on fait ça, il ne calcul pas le dt_stab de convection en FTD?? #
      # Parametre_equation parametre_implicite { resolution_explicite } #
      equation_interface interf
      equation_navier_stokes hydraulique
      phase 0
                stencil_width 9
                # correction_mpoint_diff_conv_energy 3 0 0 0  diff conv energy #
                diffusion { }
                convection { quick }
                boundary_conditions
                {
                bot   paroi_temperature_imposee champ_front_Uniforme 1 0.
                up    frontiere_ouverte T_ext Champ_front_Uniforme 1 0.
                right  frontiere_ouverte T_ext Champ_front_Fonc_xyz 1 0.
                left  Symetrie
                }
              conditions_initiales { Temperature_thermique_vapeur Champ_Fonc_xyz dom_fluide 1 0. }
              
   }
   postraitement 
   {
      champs dt_post 100
      {
         indicatrice_interf
         temperature_thermique
       vitesse
       pression
       mpoint_thermique
      }
                Probes 
               {
                  T_points grav temperature_thermique Periode 1.e-4 point 3 0.25e-3 0.125e-3 0.25e-3 0.25e-3 0.25e-3 0.5e-3 
                  T_seg grav temperature_thermique Periode 1.e-4 segment 400 1.8e-3 0 1.8e-3 1.0e-3
                  T_x10 grav temperature_thermique Periode 1.e-4 segment 400 10.e-4 0 10.e-4 1.e-3
                  T_x15 grav temperature_thermique Periode 1.e-4 segment 400 15.e-4 0 15.e-4 1.e-3
                  T_x20 grav temperature_thermique Periode 1.e-4 segment 400 20.e-4 0 20.e-4 1.e-3
                  T_x25 grav temperature_thermique Periode 1.e-4 segment 400 25.e-4 0 25.e-4 1.e-3
                  T_x30 grav temperature_thermique Periode 1.e-4 segment 400 30.e-4 0 30.e-4 1.e-3
                  T_x40 grav temperature_thermique Periode 1.e-4 segment 400 40.e-4 0 40.e-4 1.e-3
               # velocity_probe grav VitesseX Periode 1.e-4 segment 100 0. 1.875e-5 0.003 1.875e-5 #           
               }
   }
   
   liste_postraitements
   {
    postraitement_ft_lata post1 { 
     format Lata 
     fichier lata/steady 
     champs dt_post 5.0e-2 { 
        VOLUME_MAILLE elem 
        indicatrice_interf elem 
        temperature_thermique elem 
        temperature_thermique_vapeur elem 
        vitesse faces 
        pression elem 
        mpoint_thermique elem 
        interfacial_area elem 
        distance_interface_elem_interf elem
        # pression_laplacien_d elem 
        second_membre_projection elem 
        vitesse_conv_thermique faces 
        vitesse_delta_interface faces 
        terme_convection_vitesse faces 
        terme_diffusion_vitesse faces #
        # flux_tmp_interf faces  #
     } 
     interfaces interf { 
        courbure som 
        vitesse som 
        vitesse_repere_local som 
        COMPO_CONNEXE elem 
        PE elem 
        PE_LOCAL elem 
     } 
    }   
   }

sauvegarde binaire steady.sauv
# resume_last_time binaire ../R0/source.sauv #

}
Read pb2
{
	Conduction
	{
		diffusion { }
		boundary_conditions {
			sleft symetrie
			sright   PAROI_ADIABATIQUE
			sbot PAROI_ADIABATIQUE
			sup  PAROI_ADIABATIQUE

		}
		 CONDITIONS_INITIALES { temperature Champ_Uniforme 1 @dT@ }
		}

Post_processing
	{

		Format lata
		fichier slata/steady
		fields dt_post 1.0e-4
		{
		    temperature elem
		}
	}

sauvegarde binaire steady_sod.sauv
# Reprise binaire ../R0/source_sod.sauv #
}
EcritureLectureSpecial 0

Imprimer_flux dom_fluide { bot }
Imprimer_flux_sum dom_fluide { bot }

Imprimer_flux_sum dom_solide { sup }
Imprimer_flux dom_solide { sup }

Solve pbc

# EcritureLectureSpecial 0 #
End        

